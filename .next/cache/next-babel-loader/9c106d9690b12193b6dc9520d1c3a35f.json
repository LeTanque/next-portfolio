{"ast":null,"code":"/**\n * @author tschw\n * @author Mugen87 / https://github.com/Mugen87\n * @author mrdoob / http://mrdoob.com/\n *\n * Uniforms of a program.\n * Those form a tree structure with a special top-level container for the root,\n * which you get by calling 'new WebGLUniforms( gl, program )'.\n *\n *\n * Properties of inner nodes including the top-level container:\n *\n * .seq - array of nested uniforms\n * .map - nested uniforms by name\n *\n *\n * Methods of all nodes except the top-level container:\n *\n * .setValue( gl, value, [textures] )\n *\n * \t\tuploads a uniform value(s)\n *  \tthe 'textures' parameter is needed for sampler uniforms\n *\n *\n * Static methods of the top-level container (textures factorizations):\n *\n * .upload( gl, seq, values, textures )\n *\n * \t\tsets uniforms in 'seq' to 'values[id].value'\n *\n * .seqWithValue( seq, values ) : filteredSeq\n *\n * \t\tfilters 'seq' entries with corresponding entry in values\n *\n *\n * Methods of the top-level container (textures factorizations):\n *\n * .setValue( gl, name, value, textures )\n *\n * \t\tsets uniform with  name 'name' to 'value'\n *\n * .setOptional( gl, obj, prop )\n *\n * \t\tlike .set for an optional property of the object\n *\n */\nimport { CubeTexture } from '../../textures/CubeTexture.js';\nimport { Texture } from '../../textures/Texture.js';\nimport { DataTexture2DArray } from '../../textures/DataTexture2DArray.js';\nimport { DataTexture3D } from '../../textures/DataTexture3D.js';\nvar emptyTexture = new Texture();\nvar emptyTexture2dArray = new DataTexture2DArray();\nvar emptyTexture3d = new DataTexture3D();\nvar emptyCubeTexture = new CubeTexture(); // --- Utilities ---\n// Array Caches (provide typed arrays for temporary by size)\n\nvar arrayCacheF32 = [];\nvar arrayCacheI32 = []; // Float32Array caches used for uploading Matrix uniforms\n\nvar mat4array = new Float32Array(16);\nvar mat3array = new Float32Array(9);\nvar mat2array = new Float32Array(4); // Flattening for arrays of vectors and matrices\n\nfunction flatten(array, nBlocks, blockSize) {\n  var firstElem = array[0];\n  if (firstElem <= 0 || firstElem > 0) return array; // unoptimized: ! isNaN( firstElem )\n  // see http://jacksondunstan.com/articles/983\n\n  var n = nBlocks * blockSize,\n      r = arrayCacheF32[n];\n\n  if (r === undefined) {\n    r = new Float32Array(n);\n    arrayCacheF32[n] = r;\n  }\n\n  if (nBlocks !== 0) {\n    firstElem.toArray(r, 0);\n\n    for (var i = 1, offset = 0; i !== nBlocks; ++i) {\n      offset += blockSize;\n      array[i].toArray(r, offset);\n    }\n  }\n\n  return r;\n}\n\nfunction arraysEqual(a, b) {\n  if (a.length !== b.length) return false;\n\n  for (var i = 0, l = a.length; i < l; i++) {\n    if (a[i] !== b[i]) return false;\n  }\n\n  return true;\n}\n\nfunction copyArray(a, b) {\n  for (var i = 0, l = b.length; i < l; i++) {\n    a[i] = b[i];\n  }\n} // Texture unit allocation\n\n\nfunction allocTexUnits(textures, n) {\n  var r = arrayCacheI32[n];\n\n  if (r === undefined) {\n    r = new Int32Array(n);\n    arrayCacheI32[n] = r;\n  }\n\n  for (var i = 0; i !== n; ++i) {\n    r[i] = textures.allocateTextureUnit();\n  }\n\n  return r;\n} // --- Setters ---\n// Note: Defining these methods externally, because they come in a bunch\n// and this way their names minify.\n// Single scalar\n\n\nfunction setValueV1f(gl, v) {\n  var cache = this.cache;\n  if (cache[0] === v) return;\n  gl.uniform1f(this.addr, v);\n  cache[0] = v;\n} // Single float vector (from flat array or THREE.VectorN)\n\n\nfunction setValueV2f(gl, v) {\n  var cache = this.cache;\n\n  if (v.x !== undefined) {\n    if (cache[0] !== v.x || cache[1] !== v.y) {\n      gl.uniform2f(this.addr, v.x, v.y);\n      cache[0] = v.x;\n      cache[1] = v.y;\n    }\n  } else {\n    if (arraysEqual(cache, v)) return;\n    gl.uniform2fv(this.addr, v);\n    copyArray(cache, v);\n  }\n}\n\nfunction setValueV3f(gl, v) {\n  var cache = this.cache;\n\n  if (v.x !== undefined) {\n    if (cache[0] !== v.x || cache[1] !== v.y || cache[2] !== v.z) {\n      gl.uniform3f(this.addr, v.x, v.y, v.z);\n      cache[0] = v.x;\n      cache[1] = v.y;\n      cache[2] = v.z;\n    }\n  } else if (v.r !== undefined) {\n    if (cache[0] !== v.r || cache[1] !== v.g || cache[2] !== v.b) {\n      gl.uniform3f(this.addr, v.r, v.g, v.b);\n      cache[0] = v.r;\n      cache[1] = v.g;\n      cache[2] = v.b;\n    }\n  } else {\n    if (arraysEqual(cache, v)) return;\n    gl.uniform3fv(this.addr, v);\n    copyArray(cache, v);\n  }\n}\n\nfunction setValueV4f(gl, v) {\n  var cache = this.cache;\n\n  if (v.x !== undefined) {\n    if (cache[0] !== v.x || cache[1] !== v.y || cache[2] !== v.z || cache[3] !== v.w) {\n      gl.uniform4f(this.addr, v.x, v.y, v.z, v.w);\n      cache[0] = v.x;\n      cache[1] = v.y;\n      cache[2] = v.z;\n      cache[3] = v.w;\n    }\n  } else {\n    if (arraysEqual(cache, v)) return;\n    gl.uniform4fv(this.addr, v);\n    copyArray(cache, v);\n  }\n} // Single matrix (from flat array or MatrixN)\n\n\nfunction setValueM2(gl, v) {\n  var cache = this.cache;\n  var elements = v.elements;\n\n  if (elements === undefined) {\n    if (arraysEqual(cache, v)) return;\n    gl.uniformMatrix2fv(this.addr, false, v);\n    copyArray(cache, v);\n  } else {\n    if (arraysEqual(cache, elements)) return;\n    mat2array.set(elements);\n    gl.uniformMatrix2fv(this.addr, false, mat2array);\n    copyArray(cache, elements);\n  }\n}\n\nfunction setValueM3(gl, v) {\n  var cache = this.cache;\n  var elements = v.elements;\n\n  if (elements === undefined) {\n    if (arraysEqual(cache, v)) return;\n    gl.uniformMatrix3fv(this.addr, false, v);\n    copyArray(cache, v);\n  } else {\n    if (arraysEqual(cache, elements)) return;\n    mat3array.set(elements);\n    gl.uniformMatrix3fv(this.addr, false, mat3array);\n    copyArray(cache, elements);\n  }\n}\n\nfunction setValueM4(gl, v) {\n  var cache = this.cache;\n  var elements = v.elements;\n\n  if (elements === undefined) {\n    if (arraysEqual(cache, v)) return;\n    gl.uniformMatrix4fv(this.addr, false, v);\n    copyArray(cache, v);\n  } else {\n    if (arraysEqual(cache, elements)) return;\n    mat4array.set(elements);\n    gl.uniformMatrix4fv(this.addr, false, mat4array);\n    copyArray(cache, elements);\n  }\n} // Single texture (2D / Cube)\n\n\nfunction setValueT1(gl, v, textures) {\n  var cache = this.cache;\n  var unit = textures.allocateTextureUnit();\n\n  if (cache[0] !== unit) {\n    gl.uniform1i(this.addr, unit);\n    cache[0] = unit;\n  }\n\n  textures.safeSetTexture2D(v || emptyTexture, unit);\n}\n\nfunction setValueT2DArray1(gl, v, textures) {\n  var cache = this.cache;\n  var unit = textures.allocateTextureUnit();\n\n  if (cache[0] !== unit) {\n    gl.uniform1i(this.addr, unit);\n    cache[0] = unit;\n  }\n\n  textures.setTexture2DArray(v || emptyTexture2dArray, unit);\n}\n\nfunction setValueT3D1(gl, v, textures) {\n  var cache = this.cache;\n  var unit = textures.allocateTextureUnit();\n\n  if (cache[0] !== unit) {\n    gl.uniform1i(this.addr, unit);\n    cache[0] = unit;\n  }\n\n  textures.setTexture3D(v || emptyTexture3d, unit);\n}\n\nfunction setValueT6(gl, v, textures) {\n  var cache = this.cache;\n  var unit = textures.allocateTextureUnit();\n\n  if (cache[0] !== unit) {\n    gl.uniform1i(this.addr, unit);\n    cache[0] = unit;\n  }\n\n  textures.safeSetTextureCube(v || emptyCubeTexture, unit);\n} // Integer / Boolean vectors or arrays thereof (always flat arrays)\n\n\nfunction setValueV1i(gl, v) {\n  var cache = this.cache;\n  if (cache[0] === v) return;\n  gl.uniform1i(this.addr, v);\n  cache[0] = v;\n}\n\nfunction setValueV2i(gl, v) {\n  var cache = this.cache;\n  if (arraysEqual(cache, v)) return;\n  gl.uniform2iv(this.addr, v);\n  copyArray(cache, v);\n}\n\nfunction setValueV3i(gl, v) {\n  var cache = this.cache;\n  if (arraysEqual(cache, v)) return;\n  gl.uniform3iv(this.addr, v);\n  copyArray(cache, v);\n}\n\nfunction setValueV4i(gl, v) {\n  var cache = this.cache;\n  if (arraysEqual(cache, v)) return;\n  gl.uniform4iv(this.addr, v);\n  copyArray(cache, v);\n} // Helper to pick the right setter for the singular case\n\n\nfunction getSingularSetter(type) {\n  switch (type) {\n    case 0x1406:\n      return setValueV1f;\n    // FLOAT\n\n    case 0x8b50:\n      return setValueV2f;\n    // _VEC2\n\n    case 0x8b51:\n      return setValueV3f;\n    // _VEC3\n\n    case 0x8b52:\n      return setValueV4f;\n    // _VEC4\n\n    case 0x8b5a:\n      return setValueM2;\n    // _MAT2\n\n    case 0x8b5b:\n      return setValueM3;\n    // _MAT3\n\n    case 0x8b5c:\n      return setValueM4;\n    // _MAT4\n\n    case 0x8b5e:\n    case 0x8d66:\n      return setValueT1;\n    // SAMPLER_2D, SAMPLER_EXTERNAL_OES\n\n    case 0x8b5f:\n      return setValueT3D1;\n    // SAMPLER_3D\n\n    case 0x8b60:\n      return setValueT6;\n    // SAMPLER_CUBE\n\n    case 0x8DC1:\n      return setValueT2DArray1;\n    // SAMPLER_2D_ARRAY\n\n    case 0x1404:\n    case 0x8b56:\n      return setValueV1i;\n    // INT, BOOL\n\n    case 0x8b53:\n    case 0x8b57:\n      return setValueV2i;\n    // _VEC2\n\n    case 0x8b54:\n    case 0x8b58:\n      return setValueV3i;\n    // _VEC3\n\n    case 0x8b55:\n    case 0x8b59:\n      return setValueV4i;\n    // _VEC4\n  }\n} // Array of scalars\n\n\nfunction setValueV1fArray(gl, v) {\n  gl.uniform1fv(this.addr, v);\n} // Integer / Boolean vectors or arrays thereof (always flat arrays)\n\n\nfunction setValueV1iArray(gl, v) {\n  gl.uniform1iv(this.addr, v);\n}\n\nfunction setValueV2iArray(gl, v) {\n  gl.uniform2iv(this.addr, v);\n}\n\nfunction setValueV3iArray(gl, v) {\n  gl.uniform3iv(this.addr, v);\n}\n\nfunction setValueV4iArray(gl, v) {\n  gl.uniform4iv(this.addr, v);\n} // Array of vectors (flat or from THREE classes)\n\n\nfunction setValueV2fArray(gl, v) {\n  var data = flatten(v, this.size, 2);\n  gl.uniform2fv(this.addr, data);\n}\n\nfunction setValueV3fArray(gl, v) {\n  var data = flatten(v, this.size, 3);\n  gl.uniform3fv(this.addr, data);\n}\n\nfunction setValueV4fArray(gl, v) {\n  var data = flatten(v, this.size, 4);\n  gl.uniform4fv(this.addr, data);\n} // Array of matrices (flat or from THREE clases)\n\n\nfunction setValueM2Array(gl, v) {\n  var data = flatten(v, this.size, 4);\n  gl.uniformMatrix2fv(this.addr, false, data);\n}\n\nfunction setValueM3Array(gl, v) {\n  var data = flatten(v, this.size, 9);\n  gl.uniformMatrix3fv(this.addr, false, data);\n}\n\nfunction setValueM4Array(gl, v) {\n  var data = flatten(v, this.size, 16);\n  gl.uniformMatrix4fv(this.addr, false, data);\n} // Array of textures (2D / Cube)\n\n\nfunction setValueT1Array(gl, v, textures) {\n  var n = v.length;\n  var units = allocTexUnits(textures, n);\n  gl.uniform1iv(this.addr, units);\n\n  for (var i = 0; i !== n; ++i) {\n    textures.safeSetTexture2D(v[i] || emptyTexture, units[i]);\n  }\n}\n\nfunction setValueT6Array(gl, v, textures) {\n  var n = v.length;\n  var units = allocTexUnits(textures, n);\n  gl.uniform1iv(this.addr, units);\n\n  for (var i = 0; i !== n; ++i) {\n    textures.safeSetTextureCube(v[i] || emptyCubeTexture, units[i]);\n  }\n} // Helper to pick the right setter for a pure (bottom-level) array\n\n\nfunction getPureArraySetter(type) {\n  switch (type) {\n    case 0x1406:\n      return setValueV1fArray;\n    // FLOAT\n\n    case 0x8b50:\n      return setValueV2fArray;\n    // _VEC2\n\n    case 0x8b51:\n      return setValueV3fArray;\n    // _VEC3\n\n    case 0x8b52:\n      return setValueV4fArray;\n    // _VEC4\n\n    case 0x8b5a:\n      return setValueM2Array;\n    // _MAT2\n\n    case 0x8b5b:\n      return setValueM3Array;\n    // _MAT3\n\n    case 0x8b5c:\n      return setValueM4Array;\n    // _MAT4\n\n    case 0x8b5e: // SAMPLER_2D\n\n    case 0x8d66: // SAMPLER_EXTERNAL_OES\n\n    case 0x8dca: // INT_SAMPLER_2D\n\n    case 0x8dd2:\n      // UNSIGNED_INT_SAMPLER_2D\n      return setValueT1Array;\n\n    case 0x8b60: // SAMPLER_CUBE\n\n    case 0x8dcc: // INT_SAMPLER_CUBE\n\n    case 0x8dd4:\n      // UNSIGNED_SAMPLER_CUBE\n      return setValueT6Array;\n\n    case 0x1404:\n    case 0x8b56:\n      return setValueV1iArray;\n    // INT, BOOL\n\n    case 0x8b53:\n    case 0x8b57:\n      return setValueV2iArray;\n    // _VEC2\n\n    case 0x8b54:\n    case 0x8b58:\n      return setValueV3iArray;\n    // _VEC3\n\n    case 0x8b55:\n    case 0x8b59:\n      return setValueV4iArray;\n    // _VEC4\n  }\n} // --- Uniform Classes ---\n\n\nfunction SingleUniform(id, activeInfo, addr) {\n  this.id = id;\n  this.addr = addr;\n  this.cache = [];\n  this.setValue = getSingularSetter(activeInfo.type); // this.path = activeInfo.name; // DEBUG\n}\n\nfunction PureArrayUniform(id, activeInfo, addr) {\n  this.id = id;\n  this.addr = addr;\n  this.cache = [];\n  this.size = activeInfo.size;\n  this.setValue = getPureArraySetter(activeInfo.type); // this.path = activeInfo.name; // DEBUG\n}\n\nPureArrayUniform.prototype.updateCache = function (data) {\n  var cache = this.cache;\n\n  if (data instanceof Float32Array && cache.length !== data.length) {\n    this.cache = new Float32Array(data.length);\n  }\n\n  copyArray(cache, data);\n};\n\nfunction StructuredUniform(id) {\n  this.id = id;\n  this.seq = [];\n  this.map = {};\n}\n\nStructuredUniform.prototype.setValue = function (gl, value, textures) {\n  var seq = this.seq;\n\n  for (var i = 0, n = seq.length; i !== n; ++i) {\n    var u = seq[i];\n    u.setValue(gl, value[u.id], textures);\n  }\n}; // --- Top-level ---\n// Parser - builds up the property tree from the path strings\n\n\nvar RePathPart = /([\\w\\d_]+)(\\])?(\\[|\\.)?/g; // extracts\n// \t- the identifier (member name or array index)\n//  - followed by an optional right bracket (found when array index)\n//  - followed by an optional left bracket or dot (type of subscript)\n//\n// Note: These portions can be read in a non-overlapping fashion and\n// allow straightforward parsing of the hierarchy that WebGL encodes\n// in the uniform names.\n\nfunction addUniform(container, uniformObject) {\n  container.seq.push(uniformObject);\n  container.map[uniformObject.id] = uniformObject;\n}\n\nfunction parseUniform(activeInfo, addr, container) {\n  var path = activeInfo.name,\n      pathLength = path.length; // reset RegExp object, because of the early exit of a previous run\n\n  RePathPart.lastIndex = 0;\n\n  while (true) {\n    var match = RePathPart.exec(path),\n        matchEnd = RePathPart.lastIndex,\n        id = match[1],\n        idIsIndex = match[2] === ']',\n        subscript = match[3];\n    if (idIsIndex) id = id | 0; // convert to integer\n\n    if (subscript === undefined || subscript === '[' && matchEnd + 2 === pathLength) {\n      // bare name or \"pure\" bottom-level array \"[0]\" suffix\n      addUniform(container, subscript === undefined ? new SingleUniform(id, activeInfo, addr) : new PureArrayUniform(id, activeInfo, addr));\n      break;\n    } else {\n      // step into inner node / create it in case it doesn't exist\n      var map = container.map,\n          next = map[id];\n\n      if (next === undefined) {\n        next = new StructuredUniform(id);\n        addUniform(container, next);\n      }\n\n      container = next;\n    }\n  }\n} // Root Container\n\n\nfunction WebGLUniforms(gl, program) {\n  this.seq = [];\n  this.map = {};\n  var n = gl.getProgramParameter(program, gl.ACTIVE_UNIFORMS);\n\n  for (var i = 0; i < n; ++i) {\n    var info = gl.getActiveUniform(program, i),\n        addr = gl.getUniformLocation(program, info.name);\n    parseUniform(info, addr, this);\n  }\n}\n\nWebGLUniforms.prototype.setValue = function (gl, name, value, textures) {\n  var u = this.map[name];\n  if (u !== undefined) u.setValue(gl, value, textures);\n};\n\nWebGLUniforms.prototype.setOptional = function (gl, object, name) {\n  var v = object[name];\n  if (v !== undefined) this.setValue(gl, name, v);\n}; // Static interface\n\n\nWebGLUniforms.upload = function (gl, seq, values, textures) {\n  for (var i = 0, n = seq.length; i !== n; ++i) {\n    var u = seq[i],\n        v = values[u.id];\n\n    if (v.needsUpdate !== false) {\n      // note: always updating when .needsUpdate is undefined\n      u.setValue(gl, v.value, textures);\n    }\n  }\n};\n\nWebGLUniforms.seqWithValue = function (seq, values) {\n  var r = [];\n\n  for (var i = 0, n = seq.length; i !== n; ++i) {\n    var u = seq[i];\n    if (u.id in values) r.push(u);\n  }\n\n  return r;\n};\n\nexport { WebGLUniforms };","map":{"version":3,"sources":["/Users/tank/git/Portfolio/next-portfolio/node_modules/three/src/renderers/webgl/WebGLUniforms.js"],"names":["CubeTexture","Texture","DataTexture2DArray","DataTexture3D","emptyTexture","emptyTexture2dArray","emptyTexture3d","emptyCubeTexture","arrayCacheF32","arrayCacheI32","mat4array","Float32Array","mat3array","mat2array","flatten","array","nBlocks","blockSize","firstElem","n","r","undefined","toArray","i","offset","arraysEqual","a","b","length","l","copyArray","allocTexUnits","textures","Int32Array","allocateTextureUnit","setValueV1f","gl","v","cache","uniform1f","addr","setValueV2f","x","y","uniform2f","uniform2fv","setValueV3f","z","uniform3f","g","uniform3fv","setValueV4f","w","uniform4f","uniform4fv","setValueM2","elements","uniformMatrix2fv","set","setValueM3","uniformMatrix3fv","setValueM4","uniformMatrix4fv","setValueT1","unit","uniform1i","safeSetTexture2D","setValueT2DArray1","setTexture2DArray","setValueT3D1","setTexture3D","setValueT6","safeSetTextureCube","setValueV1i","setValueV2i","uniform2iv","setValueV3i","uniform3iv","setValueV4i","uniform4iv","getSingularSetter","type","setValueV1fArray","uniform1fv","setValueV1iArray","uniform1iv","setValueV2iArray","setValueV3iArray","setValueV4iArray","setValueV2fArray","data","size","setValueV3fArray","setValueV4fArray","setValueM2Array","setValueM3Array","setValueM4Array","setValueT1Array","units","setValueT6Array","getPureArraySetter","SingleUniform","id","activeInfo","setValue","PureArrayUniform","prototype","updateCache","StructuredUniform","seq","map","value","u","RePathPart","addUniform","container","uniformObject","push","parseUniform","path","name","pathLength","lastIndex","match","exec","matchEnd","idIsIndex","subscript","next","WebGLUniforms","program","getProgramParameter","ACTIVE_UNIFORMS","info","getActiveUniform","getUniformLocation","setOptional","object","upload","values","needsUpdate","seqWithValue"],"mappings":"AAAA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AA+CA,SAASA,WAAT,QAA4B,+BAA5B;AACA,SAASC,OAAT,QAAwB,2BAAxB;AACA,SAASC,kBAAT,QAAmC,sCAAnC;AACA,SAASC,aAAT,QAA8B,iCAA9B;AAEA,IAAIC,YAAY,GAAG,IAAIH,OAAJ,EAAnB;AACA,IAAII,mBAAmB,GAAG,IAAIH,kBAAJ,EAA1B;AACA,IAAII,cAAc,GAAG,IAAIH,aAAJ,EAArB;AACA,IAAII,gBAAgB,GAAG,IAAIP,WAAJ,EAAvB,C,CAEA;AAEA;;AAEA,IAAIQ,aAAa,GAAG,EAApB;AACA,IAAIC,aAAa,GAAG,EAApB,C,CAEA;;AAEA,IAAIC,SAAS,GAAG,IAAIC,YAAJ,CAAkB,EAAlB,CAAhB;AACA,IAAIC,SAAS,GAAG,IAAID,YAAJ,CAAkB,CAAlB,CAAhB;AACA,IAAIE,SAAS,GAAG,IAAIF,YAAJ,CAAkB,CAAlB,CAAhB,C,CAEA;;AAEA,SAASG,OAAT,CAAkBC,KAAlB,EAAyBC,OAAzB,EAAkCC,SAAlC,EAA8C;AAE7C,MAAIC,SAAS,GAAGH,KAAK,CAAE,CAAF,CAArB;AAEA,MAAKG,SAAS,IAAI,CAAb,IAAkBA,SAAS,GAAG,CAAnC,EAAuC,OAAOH,KAAP,CAJM,CAK7C;AACA;;AAEA,MAAII,CAAC,GAAGH,OAAO,GAAGC,SAAlB;AAAA,MACCG,CAAC,GAAGZ,aAAa,CAAEW,CAAF,CADlB;;AAGA,MAAKC,CAAC,KAAKC,SAAX,EAAuB;AAEtBD,IAAAA,CAAC,GAAG,IAAIT,YAAJ,CAAkBQ,CAAlB,CAAJ;AACAX,IAAAA,aAAa,CAAEW,CAAF,CAAb,GAAqBC,CAArB;AAEA;;AAED,MAAKJ,OAAO,KAAK,CAAjB,EAAqB;AAEpBE,IAAAA,SAAS,CAACI,OAAV,CAAmBF,CAAnB,EAAsB,CAAtB;;AAEA,SAAM,IAAIG,CAAC,GAAG,CAAR,EAAWC,MAAM,GAAG,CAA1B,EAA6BD,CAAC,KAAKP,OAAnC,EAA4C,EAAGO,CAA/C,EAAmD;AAElDC,MAAAA,MAAM,IAAIP,SAAV;AACAF,MAAAA,KAAK,CAAEQ,CAAF,CAAL,CAAWD,OAAX,CAAoBF,CAApB,EAAuBI,MAAvB;AAEA;AAED;;AAED,SAAOJ,CAAP;AAEA;;AAED,SAASK,WAAT,CAAsBC,CAAtB,EAAyBC,CAAzB,EAA6B;AAE5B,MAAKD,CAAC,CAACE,MAAF,KAAaD,CAAC,CAACC,MAApB,EAA6B,OAAO,KAAP;;AAE7B,OAAM,IAAIL,CAAC,GAAG,CAAR,EAAWM,CAAC,GAAGH,CAAC,CAACE,MAAvB,EAA+BL,CAAC,GAAGM,CAAnC,EAAsCN,CAAC,EAAvC,EAA6C;AAE5C,QAAKG,CAAC,CAAEH,CAAF,CAAD,KAAWI,CAAC,CAAEJ,CAAF,CAAjB,EAAyB,OAAO,KAAP;AAEzB;;AAED,SAAO,IAAP;AAEA;;AAED,SAASO,SAAT,CAAoBJ,CAApB,EAAuBC,CAAvB,EAA2B;AAE1B,OAAM,IAAIJ,CAAC,GAAG,CAAR,EAAWM,CAAC,GAAGF,CAAC,CAACC,MAAvB,EAA+BL,CAAC,GAAGM,CAAnC,EAAsCN,CAAC,EAAvC,EAA6C;AAE5CG,IAAAA,CAAC,CAAEH,CAAF,CAAD,GAASI,CAAC,CAAEJ,CAAF,CAAV;AAEA;AAED,C,CAED;;;AAEA,SAASQ,aAAT,CAAwBC,QAAxB,EAAkCb,CAAlC,EAAsC;AAErC,MAAIC,CAAC,GAAGX,aAAa,CAAEU,CAAF,CAArB;;AAEA,MAAKC,CAAC,KAAKC,SAAX,EAAuB;AAEtBD,IAAAA,CAAC,GAAG,IAAIa,UAAJ,CAAgBd,CAAhB,CAAJ;AACAV,IAAAA,aAAa,CAAEU,CAAF,CAAb,GAAqBC,CAArB;AAEA;;AAED,OAAM,IAAIG,CAAC,GAAG,CAAd,EAAiBA,CAAC,KAAKJ,CAAvB,EAA0B,EAAGI,CAA7B;AACCH,IAAAA,CAAC,CAAEG,CAAF,CAAD,GAASS,QAAQ,CAACE,mBAAT,EAAT;AADD;;AAGA,SAAOd,CAAP;AAEA,C,CAED;AAEA;AACA;AAEA;;;AAEA,SAASe,WAAT,CAAsBC,EAAtB,EAA0BC,CAA1B,EAA8B;AAE7B,MAAIC,KAAK,GAAG,KAAKA,KAAjB;AAEA,MAAKA,KAAK,CAAE,CAAF,CAAL,KAAeD,CAApB,EAAwB;AAExBD,EAAAA,EAAE,CAACG,SAAH,CAAc,KAAKC,IAAnB,EAAyBH,CAAzB;AAEAC,EAAAA,KAAK,CAAE,CAAF,CAAL,GAAaD,CAAb;AAEA,C,CAED;;;AAEA,SAASI,WAAT,CAAsBL,EAAtB,EAA0BC,CAA1B,EAA8B;AAE7B,MAAIC,KAAK,GAAG,KAAKA,KAAjB;;AAEA,MAAKD,CAAC,CAACK,CAAF,KAAQrB,SAAb,EAAyB;AAExB,QAAKiB,KAAK,CAAE,CAAF,CAAL,KAAeD,CAAC,CAACK,CAAjB,IAAsBJ,KAAK,CAAE,CAAF,CAAL,KAAeD,CAAC,CAACM,CAA5C,EAAgD;AAE/CP,MAAAA,EAAE,CAACQ,SAAH,CAAc,KAAKJ,IAAnB,EAAyBH,CAAC,CAACK,CAA3B,EAA8BL,CAAC,CAACM,CAAhC;AAEAL,MAAAA,KAAK,CAAE,CAAF,CAAL,GAAaD,CAAC,CAACK,CAAf;AACAJ,MAAAA,KAAK,CAAE,CAAF,CAAL,GAAaD,CAAC,CAACM,CAAf;AAEA;AAED,GAXD,MAWO;AAEN,QAAKlB,WAAW,CAAEa,KAAF,EAASD,CAAT,CAAhB,EAA+B;AAE/BD,IAAAA,EAAE,CAACS,UAAH,CAAe,KAAKL,IAApB,EAA0BH,CAA1B;AAEAP,IAAAA,SAAS,CAAEQ,KAAF,EAASD,CAAT,CAAT;AAEA;AAED;;AAED,SAASS,WAAT,CAAsBV,EAAtB,EAA0BC,CAA1B,EAA8B;AAE7B,MAAIC,KAAK,GAAG,KAAKA,KAAjB;;AAEA,MAAKD,CAAC,CAACK,CAAF,KAAQrB,SAAb,EAAyB;AAExB,QAAKiB,KAAK,CAAE,CAAF,CAAL,KAAeD,CAAC,CAACK,CAAjB,IAAsBJ,KAAK,CAAE,CAAF,CAAL,KAAeD,CAAC,CAACM,CAAvC,IAA4CL,KAAK,CAAE,CAAF,CAAL,KAAeD,CAAC,CAACU,CAAlE,EAAsE;AAErEX,MAAAA,EAAE,CAACY,SAAH,CAAc,KAAKR,IAAnB,EAAyBH,CAAC,CAACK,CAA3B,EAA8BL,CAAC,CAACM,CAAhC,EAAmCN,CAAC,CAACU,CAArC;AAEAT,MAAAA,KAAK,CAAE,CAAF,CAAL,GAAaD,CAAC,CAACK,CAAf;AACAJ,MAAAA,KAAK,CAAE,CAAF,CAAL,GAAaD,CAAC,CAACM,CAAf;AACAL,MAAAA,KAAK,CAAE,CAAF,CAAL,GAAaD,CAAC,CAACU,CAAf;AAEA;AAED,GAZD,MAYO,IAAKV,CAAC,CAACjB,CAAF,KAAQC,SAAb,EAAyB;AAE/B,QAAKiB,KAAK,CAAE,CAAF,CAAL,KAAeD,CAAC,CAACjB,CAAjB,IAAsBkB,KAAK,CAAE,CAAF,CAAL,KAAeD,CAAC,CAACY,CAAvC,IAA4CX,KAAK,CAAE,CAAF,CAAL,KAAeD,CAAC,CAACV,CAAlE,EAAsE;AAErES,MAAAA,EAAE,CAACY,SAAH,CAAc,KAAKR,IAAnB,EAAyBH,CAAC,CAACjB,CAA3B,EAA8BiB,CAAC,CAACY,CAAhC,EAAmCZ,CAAC,CAACV,CAArC;AAEAW,MAAAA,KAAK,CAAE,CAAF,CAAL,GAAaD,CAAC,CAACjB,CAAf;AACAkB,MAAAA,KAAK,CAAE,CAAF,CAAL,GAAaD,CAAC,CAACY,CAAf;AACAX,MAAAA,KAAK,CAAE,CAAF,CAAL,GAAaD,CAAC,CAACV,CAAf;AAEA;AAED,GAZM,MAYA;AAEN,QAAKF,WAAW,CAAEa,KAAF,EAASD,CAAT,CAAhB,EAA+B;AAE/BD,IAAAA,EAAE,CAACc,UAAH,CAAe,KAAKV,IAApB,EAA0BH,CAA1B;AAEAP,IAAAA,SAAS,CAAEQ,KAAF,EAASD,CAAT,CAAT;AAEA;AAED;;AAED,SAASc,WAAT,CAAsBf,EAAtB,EAA0BC,CAA1B,EAA8B;AAE7B,MAAIC,KAAK,GAAG,KAAKA,KAAjB;;AAEA,MAAKD,CAAC,CAACK,CAAF,KAAQrB,SAAb,EAAyB;AAExB,QAAKiB,KAAK,CAAE,CAAF,CAAL,KAAeD,CAAC,CAACK,CAAjB,IAAsBJ,KAAK,CAAE,CAAF,CAAL,KAAeD,CAAC,CAACM,CAAvC,IAA4CL,KAAK,CAAE,CAAF,CAAL,KAAeD,CAAC,CAACU,CAA7D,IAAkET,KAAK,CAAE,CAAF,CAAL,KAAeD,CAAC,CAACe,CAAxF,EAA4F;AAE3FhB,MAAAA,EAAE,CAACiB,SAAH,CAAc,KAAKb,IAAnB,EAAyBH,CAAC,CAACK,CAA3B,EAA8BL,CAAC,CAACM,CAAhC,EAAmCN,CAAC,CAACU,CAArC,EAAwCV,CAAC,CAACe,CAA1C;AAEAd,MAAAA,KAAK,CAAE,CAAF,CAAL,GAAaD,CAAC,CAACK,CAAf;AACAJ,MAAAA,KAAK,CAAE,CAAF,CAAL,GAAaD,CAAC,CAACM,CAAf;AACAL,MAAAA,KAAK,CAAE,CAAF,CAAL,GAAaD,CAAC,CAACU,CAAf;AACAT,MAAAA,KAAK,CAAE,CAAF,CAAL,GAAaD,CAAC,CAACe,CAAf;AAEA;AAED,GAbD,MAaO;AAEN,QAAK3B,WAAW,CAAEa,KAAF,EAASD,CAAT,CAAhB,EAA+B;AAE/BD,IAAAA,EAAE,CAACkB,UAAH,CAAe,KAAKd,IAApB,EAA0BH,CAA1B;AAEAP,IAAAA,SAAS,CAAEQ,KAAF,EAASD,CAAT,CAAT;AAEA;AAED,C,CAED;;;AAEA,SAASkB,UAAT,CAAqBnB,EAArB,EAAyBC,CAAzB,EAA6B;AAE5B,MAAIC,KAAK,GAAG,KAAKA,KAAjB;AACA,MAAIkB,QAAQ,GAAGnB,CAAC,CAACmB,QAAjB;;AAEA,MAAKA,QAAQ,KAAKnC,SAAlB,EAA8B;AAE7B,QAAKI,WAAW,CAAEa,KAAF,EAASD,CAAT,CAAhB,EAA+B;AAE/BD,IAAAA,EAAE,CAACqB,gBAAH,CAAqB,KAAKjB,IAA1B,EAAgC,KAAhC,EAAuCH,CAAvC;AAEAP,IAAAA,SAAS,CAAEQ,KAAF,EAASD,CAAT,CAAT;AAEA,GARD,MAQO;AAEN,QAAKZ,WAAW,CAAEa,KAAF,EAASkB,QAAT,CAAhB,EAAsC;AAEtC3C,IAAAA,SAAS,CAAC6C,GAAV,CAAeF,QAAf;AAEApB,IAAAA,EAAE,CAACqB,gBAAH,CAAqB,KAAKjB,IAA1B,EAAgC,KAAhC,EAAuC3B,SAAvC;AAEAiB,IAAAA,SAAS,CAAEQ,KAAF,EAASkB,QAAT,CAAT;AAEA;AAED;;AAED,SAASG,UAAT,CAAqBvB,EAArB,EAAyBC,CAAzB,EAA6B;AAE5B,MAAIC,KAAK,GAAG,KAAKA,KAAjB;AACA,MAAIkB,QAAQ,GAAGnB,CAAC,CAACmB,QAAjB;;AAEA,MAAKA,QAAQ,KAAKnC,SAAlB,EAA8B;AAE7B,QAAKI,WAAW,CAAEa,KAAF,EAASD,CAAT,CAAhB,EAA+B;AAE/BD,IAAAA,EAAE,CAACwB,gBAAH,CAAqB,KAAKpB,IAA1B,EAAgC,KAAhC,EAAuCH,CAAvC;AAEAP,IAAAA,SAAS,CAAEQ,KAAF,EAASD,CAAT,CAAT;AAEA,GARD,MAQO;AAEN,QAAKZ,WAAW,CAAEa,KAAF,EAASkB,QAAT,CAAhB,EAAsC;AAEtC5C,IAAAA,SAAS,CAAC8C,GAAV,CAAeF,QAAf;AAEApB,IAAAA,EAAE,CAACwB,gBAAH,CAAqB,KAAKpB,IAA1B,EAAgC,KAAhC,EAAuC5B,SAAvC;AAEAkB,IAAAA,SAAS,CAAEQ,KAAF,EAASkB,QAAT,CAAT;AAEA;AAED;;AAED,SAASK,UAAT,CAAqBzB,EAArB,EAAyBC,CAAzB,EAA6B;AAE5B,MAAIC,KAAK,GAAG,KAAKA,KAAjB;AACA,MAAIkB,QAAQ,GAAGnB,CAAC,CAACmB,QAAjB;;AAEA,MAAKA,QAAQ,KAAKnC,SAAlB,EAA8B;AAE7B,QAAKI,WAAW,CAAEa,KAAF,EAASD,CAAT,CAAhB,EAA+B;AAE/BD,IAAAA,EAAE,CAAC0B,gBAAH,CAAqB,KAAKtB,IAA1B,EAAgC,KAAhC,EAAuCH,CAAvC;AAEAP,IAAAA,SAAS,CAAEQ,KAAF,EAASD,CAAT,CAAT;AAEA,GARD,MAQO;AAEN,QAAKZ,WAAW,CAAEa,KAAF,EAASkB,QAAT,CAAhB,EAAsC;AAEtC9C,IAAAA,SAAS,CAACgD,GAAV,CAAeF,QAAf;AAEApB,IAAAA,EAAE,CAAC0B,gBAAH,CAAqB,KAAKtB,IAA1B,EAAgC,KAAhC,EAAuC9B,SAAvC;AAEAoB,IAAAA,SAAS,CAAEQ,KAAF,EAASkB,QAAT,CAAT;AAEA;AAED,C,CAED;;;AAEA,SAASO,UAAT,CAAqB3B,EAArB,EAAyBC,CAAzB,EAA4BL,QAA5B,EAAuC;AAEtC,MAAIM,KAAK,GAAG,KAAKA,KAAjB;AACA,MAAI0B,IAAI,GAAGhC,QAAQ,CAACE,mBAAT,EAAX;;AAEA,MAAKI,KAAK,CAAE,CAAF,CAAL,KAAe0B,IAApB,EAA2B;AAE1B5B,IAAAA,EAAE,CAAC6B,SAAH,CAAc,KAAKzB,IAAnB,EAAyBwB,IAAzB;AACA1B,IAAAA,KAAK,CAAE,CAAF,CAAL,GAAa0B,IAAb;AAEA;;AAEDhC,EAAAA,QAAQ,CAACkC,gBAAT,CAA2B7B,CAAC,IAAIjC,YAAhC,EAA8C4D,IAA9C;AAEA;;AAED,SAASG,iBAAT,CAA4B/B,EAA5B,EAAgCC,CAAhC,EAAmCL,QAAnC,EAA8C;AAE7C,MAAIM,KAAK,GAAG,KAAKA,KAAjB;AACA,MAAI0B,IAAI,GAAGhC,QAAQ,CAACE,mBAAT,EAAX;;AAEA,MAAKI,KAAK,CAAE,CAAF,CAAL,KAAe0B,IAApB,EAA2B;AAE1B5B,IAAAA,EAAE,CAAC6B,SAAH,CAAc,KAAKzB,IAAnB,EAAyBwB,IAAzB;AACA1B,IAAAA,KAAK,CAAE,CAAF,CAAL,GAAa0B,IAAb;AAEA;;AAEDhC,EAAAA,QAAQ,CAACoC,iBAAT,CAA4B/B,CAAC,IAAIhC,mBAAjC,EAAsD2D,IAAtD;AAEA;;AAED,SAASK,YAAT,CAAuBjC,EAAvB,EAA2BC,CAA3B,EAA8BL,QAA9B,EAAyC;AAExC,MAAIM,KAAK,GAAG,KAAKA,KAAjB;AACA,MAAI0B,IAAI,GAAGhC,QAAQ,CAACE,mBAAT,EAAX;;AAEA,MAAKI,KAAK,CAAE,CAAF,CAAL,KAAe0B,IAApB,EAA2B;AAE1B5B,IAAAA,EAAE,CAAC6B,SAAH,CAAc,KAAKzB,IAAnB,EAAyBwB,IAAzB;AACA1B,IAAAA,KAAK,CAAE,CAAF,CAAL,GAAa0B,IAAb;AAEA;;AAEDhC,EAAAA,QAAQ,CAACsC,YAAT,CAAuBjC,CAAC,IAAI/B,cAA5B,EAA4C0D,IAA5C;AAEA;;AAED,SAASO,UAAT,CAAqBnC,EAArB,EAAyBC,CAAzB,EAA4BL,QAA5B,EAAuC;AAEtC,MAAIM,KAAK,GAAG,KAAKA,KAAjB;AACA,MAAI0B,IAAI,GAAGhC,QAAQ,CAACE,mBAAT,EAAX;;AAEA,MAAKI,KAAK,CAAE,CAAF,CAAL,KAAe0B,IAApB,EAA2B;AAE1B5B,IAAAA,EAAE,CAAC6B,SAAH,CAAc,KAAKzB,IAAnB,EAAyBwB,IAAzB;AACA1B,IAAAA,KAAK,CAAE,CAAF,CAAL,GAAa0B,IAAb;AAEA;;AAEDhC,EAAAA,QAAQ,CAACwC,kBAAT,CAA6BnC,CAAC,IAAI9B,gBAAlC,EAAoDyD,IAApD;AAEA,C,CAED;;;AAEA,SAASS,WAAT,CAAsBrC,EAAtB,EAA0BC,CAA1B,EAA8B;AAE7B,MAAIC,KAAK,GAAG,KAAKA,KAAjB;AAEA,MAAKA,KAAK,CAAE,CAAF,CAAL,KAAeD,CAApB,EAAwB;AAExBD,EAAAA,EAAE,CAAC6B,SAAH,CAAc,KAAKzB,IAAnB,EAAyBH,CAAzB;AAEAC,EAAAA,KAAK,CAAE,CAAF,CAAL,GAAaD,CAAb;AAEA;;AAED,SAASqC,WAAT,CAAsBtC,EAAtB,EAA0BC,CAA1B,EAA8B;AAE7B,MAAIC,KAAK,GAAG,KAAKA,KAAjB;AAEA,MAAKb,WAAW,CAAEa,KAAF,EAASD,CAAT,CAAhB,EAA+B;AAE/BD,EAAAA,EAAE,CAACuC,UAAH,CAAe,KAAKnC,IAApB,EAA0BH,CAA1B;AAEAP,EAAAA,SAAS,CAAEQ,KAAF,EAASD,CAAT,CAAT;AAEA;;AAED,SAASuC,WAAT,CAAsBxC,EAAtB,EAA0BC,CAA1B,EAA8B;AAE7B,MAAIC,KAAK,GAAG,KAAKA,KAAjB;AAEA,MAAKb,WAAW,CAAEa,KAAF,EAASD,CAAT,CAAhB,EAA+B;AAE/BD,EAAAA,EAAE,CAACyC,UAAH,CAAe,KAAKrC,IAApB,EAA0BH,CAA1B;AAEAP,EAAAA,SAAS,CAAEQ,KAAF,EAASD,CAAT,CAAT;AAEA;;AAED,SAASyC,WAAT,CAAsB1C,EAAtB,EAA0BC,CAA1B,EAA8B;AAE7B,MAAIC,KAAK,GAAG,KAAKA,KAAjB;AAEA,MAAKb,WAAW,CAAEa,KAAF,EAASD,CAAT,CAAhB,EAA+B;AAE/BD,EAAAA,EAAE,CAAC2C,UAAH,CAAe,KAAKvC,IAApB,EAA0BH,CAA1B;AAEAP,EAAAA,SAAS,CAAEQ,KAAF,EAASD,CAAT,CAAT;AAEA,C,CAED;;;AAEA,SAAS2C,iBAAT,CAA4BC,IAA5B,EAAmC;AAElC,UAASA,IAAT;AAEC,SAAK,MAAL;AAAa,aAAO9C,WAAP;AAAoB;;AACjC,SAAK,MAAL;AAAa,aAAOM,WAAP;AAAoB;;AACjC,SAAK,MAAL;AAAa,aAAOK,WAAP;AAAoB;;AACjC,SAAK,MAAL;AAAa,aAAOK,WAAP;AAAoB;;AAEjC,SAAK,MAAL;AAAa,aAAOI,UAAP;AAAmB;;AAChC,SAAK,MAAL;AAAa,aAAOI,UAAP;AAAmB;;AAChC,SAAK,MAAL;AAAa,aAAOE,UAAP;AAAmB;;AAEhC,SAAK,MAAL;AAAa,SAAK,MAAL;AAAa,aAAOE,UAAP;AAAmB;;AAC7C,SAAK,MAAL;AAAa,aAAOM,YAAP;AAAqB;;AAClC,SAAK,MAAL;AAAa,aAAOE,UAAP;AAAmB;;AAChC,SAAK,MAAL;AAAa,aAAOJ,iBAAP;AAA0B;;AAEvC,SAAK,MAAL;AAAa,SAAK,MAAL;AAAa,aAAOM,WAAP;AAAoB;;AAC9C,SAAK,MAAL;AAAa,SAAK,MAAL;AAAa,aAAOC,WAAP;AAAoB;;AAC9C,SAAK,MAAL;AAAa,SAAK,MAAL;AAAa,aAAOE,WAAP;AAAoB;;AAC9C,SAAK,MAAL;AAAa,SAAK,MAAL;AAAa,aAAOE,WAAP;AAAoB;AAnB/C;AAuBA,C,CAED;;;AACA,SAASI,gBAAT,CAA2B9C,EAA3B,EAA+BC,CAA/B,EAAmC;AAElCD,EAAAA,EAAE,CAAC+C,UAAH,CAAe,KAAK3C,IAApB,EAA0BH,CAA1B;AAEA,C,CAED;;;AACA,SAAS+C,gBAAT,CAA2BhD,EAA3B,EAA+BC,CAA/B,EAAmC;AAElCD,EAAAA,EAAE,CAACiD,UAAH,CAAe,KAAK7C,IAApB,EAA0BH,CAA1B;AAEA;;AAED,SAASiD,gBAAT,CAA2BlD,EAA3B,EAA+BC,CAA/B,EAAmC;AAElCD,EAAAA,EAAE,CAACuC,UAAH,CAAe,KAAKnC,IAApB,EAA0BH,CAA1B;AAEA;;AAED,SAASkD,gBAAT,CAA2BnD,EAA3B,EAA+BC,CAA/B,EAAmC;AAElCD,EAAAA,EAAE,CAACyC,UAAH,CAAe,KAAKrC,IAApB,EAA0BH,CAA1B;AAEA;;AAED,SAASmD,gBAAT,CAA2BpD,EAA3B,EAA+BC,CAA/B,EAAmC;AAElCD,EAAAA,EAAE,CAAC2C,UAAH,CAAe,KAAKvC,IAApB,EAA0BH,CAA1B;AAEA,C,CAGD;;;AAEA,SAASoD,gBAAT,CAA2BrD,EAA3B,EAA+BC,CAA/B,EAAmC;AAElC,MAAIqD,IAAI,GAAG5E,OAAO,CAAEuB,CAAF,EAAK,KAAKsD,IAAV,EAAgB,CAAhB,CAAlB;AAEAvD,EAAAA,EAAE,CAACS,UAAH,CAAe,KAAKL,IAApB,EAA0BkD,IAA1B;AAEA;;AAED,SAASE,gBAAT,CAA2BxD,EAA3B,EAA+BC,CAA/B,EAAmC;AAElC,MAAIqD,IAAI,GAAG5E,OAAO,CAAEuB,CAAF,EAAK,KAAKsD,IAAV,EAAgB,CAAhB,CAAlB;AAEAvD,EAAAA,EAAE,CAACc,UAAH,CAAe,KAAKV,IAApB,EAA0BkD,IAA1B;AAEA;;AAED,SAASG,gBAAT,CAA2BzD,EAA3B,EAA+BC,CAA/B,EAAmC;AAElC,MAAIqD,IAAI,GAAG5E,OAAO,CAAEuB,CAAF,EAAK,KAAKsD,IAAV,EAAgB,CAAhB,CAAlB;AAEAvD,EAAAA,EAAE,CAACkB,UAAH,CAAe,KAAKd,IAApB,EAA0BkD,IAA1B;AAEA,C,CAED;;;AAEA,SAASI,eAAT,CAA0B1D,EAA1B,EAA8BC,CAA9B,EAAkC;AAEjC,MAAIqD,IAAI,GAAG5E,OAAO,CAAEuB,CAAF,EAAK,KAAKsD,IAAV,EAAgB,CAAhB,CAAlB;AAEAvD,EAAAA,EAAE,CAACqB,gBAAH,CAAqB,KAAKjB,IAA1B,EAAgC,KAAhC,EAAuCkD,IAAvC;AAEA;;AAED,SAASK,eAAT,CAA0B3D,EAA1B,EAA8BC,CAA9B,EAAkC;AAEjC,MAAIqD,IAAI,GAAG5E,OAAO,CAAEuB,CAAF,EAAK,KAAKsD,IAAV,EAAgB,CAAhB,CAAlB;AAEAvD,EAAAA,EAAE,CAACwB,gBAAH,CAAqB,KAAKpB,IAA1B,EAAgC,KAAhC,EAAuCkD,IAAvC;AAEA;;AAED,SAASM,eAAT,CAA0B5D,EAA1B,EAA8BC,CAA9B,EAAkC;AAEjC,MAAIqD,IAAI,GAAG5E,OAAO,CAAEuB,CAAF,EAAK,KAAKsD,IAAV,EAAgB,EAAhB,CAAlB;AAEAvD,EAAAA,EAAE,CAAC0B,gBAAH,CAAqB,KAAKtB,IAA1B,EAAgC,KAAhC,EAAuCkD,IAAvC;AAEA,C,CAED;;;AAEA,SAASO,eAAT,CAA0B7D,EAA1B,EAA8BC,CAA9B,EAAiCL,QAAjC,EAA4C;AAE3C,MAAIb,CAAC,GAAGkB,CAAC,CAACT,MAAV;AAEA,MAAIsE,KAAK,GAAGnE,aAAa,CAAEC,QAAF,EAAYb,CAAZ,CAAzB;AAEAiB,EAAAA,EAAE,CAACiD,UAAH,CAAe,KAAK7C,IAApB,EAA0B0D,KAA1B;;AAEA,OAAM,IAAI3E,CAAC,GAAG,CAAd,EAAiBA,CAAC,KAAKJ,CAAvB,EAA0B,EAAGI,CAA7B,EAAiC;AAEhCS,IAAAA,QAAQ,CAACkC,gBAAT,CAA2B7B,CAAC,CAAEd,CAAF,CAAD,IAAUnB,YAArC,EAAmD8F,KAAK,CAAE3E,CAAF,CAAxD;AAEA;AAED;;AAED,SAAS4E,eAAT,CAA0B/D,EAA1B,EAA8BC,CAA9B,EAAiCL,QAAjC,EAA4C;AAE3C,MAAIb,CAAC,GAAGkB,CAAC,CAACT,MAAV;AAEA,MAAIsE,KAAK,GAAGnE,aAAa,CAAEC,QAAF,EAAYb,CAAZ,CAAzB;AAEAiB,EAAAA,EAAE,CAACiD,UAAH,CAAe,KAAK7C,IAApB,EAA0B0D,KAA1B;;AAEA,OAAM,IAAI3E,CAAC,GAAG,CAAd,EAAiBA,CAAC,KAAKJ,CAAvB,EAA0B,EAAGI,CAA7B,EAAiC;AAEhCS,IAAAA,QAAQ,CAACwC,kBAAT,CAA6BnC,CAAC,CAAEd,CAAF,CAAD,IAAUhB,gBAAvC,EAAyD2F,KAAK,CAAE3E,CAAF,CAA9D;AAEA;AAED,C,CAED;;;AAEA,SAAS6E,kBAAT,CAA6BnB,IAA7B,EAAoC;AAEnC,UAASA,IAAT;AAEC,SAAK,MAAL;AAAa,aAAOC,gBAAP;AAAyB;;AACtC,SAAK,MAAL;AAAa,aAAOO,gBAAP;AAAyB;;AACtC,SAAK,MAAL;AAAa,aAAOG,gBAAP;AAAyB;;AACtC,SAAK,MAAL;AAAa,aAAOC,gBAAP;AAAyB;;AAEtC,SAAK,MAAL;AAAa,aAAOC,eAAP;AAAwB;;AACrC,SAAK,MAAL;AAAa,aAAOC,eAAP;AAAwB;;AACrC,SAAK,MAAL;AAAa,aAAOC,eAAP;AAAwB;;AAErC,SAAK,MAAL,CAXD,CAWc;;AACb,SAAK,MAAL,CAZD,CAYc;;AACb,SAAK,MAAL,CAbD,CAac;;AACb,SAAK,MAAL;AAAa;AACZ,aAAOC,eAAP;;AAED,SAAK,MAAL,CAjBD,CAiBc;;AACb,SAAK,MAAL,CAlBD,CAkBc;;AACb,SAAK,MAAL;AAAa;AACZ,aAAOE,eAAP;;AAED,SAAK,MAAL;AAAa,SAAK,MAAL;AAAa,aAAOf,gBAAP;AAAyB;;AACnD,SAAK,MAAL;AAAa,SAAK,MAAL;AAAa,aAAOE,gBAAP;AAAyB;;AACnD,SAAK,MAAL;AAAa,SAAK,MAAL;AAAa,aAAOC,gBAAP;AAAyB;;AACnD,SAAK,MAAL;AAAa,SAAK,MAAL;AAAa,aAAOC,gBAAP;AAAyB;AAzBpD;AA6BA,C,CAED;;;AAEA,SAASa,aAAT,CAAwBC,EAAxB,EAA4BC,UAA5B,EAAwC/D,IAAxC,EAA+C;AAE9C,OAAK8D,EAAL,GAAUA,EAAV;AACA,OAAK9D,IAAL,GAAYA,IAAZ;AACA,OAAKF,KAAL,GAAa,EAAb;AACA,OAAKkE,QAAL,GAAgBxB,iBAAiB,CAAEuB,UAAU,CAACtB,IAAb,CAAjC,CAL8C,CAO9C;AAEA;;AAED,SAASwB,gBAAT,CAA2BH,EAA3B,EAA+BC,UAA/B,EAA2C/D,IAA3C,EAAkD;AAEjD,OAAK8D,EAAL,GAAUA,EAAV;AACA,OAAK9D,IAAL,GAAYA,IAAZ;AACA,OAAKF,KAAL,GAAa,EAAb;AACA,OAAKqD,IAAL,GAAYY,UAAU,CAACZ,IAAvB;AACA,OAAKa,QAAL,GAAgBJ,kBAAkB,CAAEG,UAAU,CAACtB,IAAb,CAAlC,CANiD,CAQjD;AAEA;;AAEDwB,gBAAgB,CAACC,SAAjB,CAA2BC,WAA3B,GAAyC,UAAWjB,IAAX,EAAkB;AAE1D,MAAIpD,KAAK,GAAG,KAAKA,KAAjB;;AAEA,MAAKoD,IAAI,YAAY/E,YAAhB,IAAgC2B,KAAK,CAACV,MAAN,KAAiB8D,IAAI,CAAC9D,MAA3D,EAAoE;AAEnE,SAAKU,KAAL,GAAa,IAAI3B,YAAJ,CAAkB+E,IAAI,CAAC9D,MAAvB,CAAb;AAEA;;AAEDE,EAAAA,SAAS,CAAEQ,KAAF,EAASoD,IAAT,CAAT;AAEA,CAZD;;AAcA,SAASkB,iBAAT,CAA4BN,EAA5B,EAAiC;AAEhC,OAAKA,EAAL,GAAUA,EAAV;AAEA,OAAKO,GAAL,GAAW,EAAX;AACA,OAAKC,GAAL,GAAW,EAAX;AAEA;;AAEDF,iBAAiB,CAACF,SAAlB,CAA4BF,QAA5B,GAAuC,UAAWpE,EAAX,EAAe2E,KAAf,EAAsB/E,QAAtB,EAAiC;AAEvE,MAAI6E,GAAG,GAAG,KAAKA,GAAf;;AAEA,OAAM,IAAItF,CAAC,GAAG,CAAR,EAAWJ,CAAC,GAAG0F,GAAG,CAACjF,MAAzB,EAAiCL,CAAC,KAAKJ,CAAvC,EAA0C,EAAGI,CAA7C,EAAiD;AAEhD,QAAIyF,CAAC,GAAGH,GAAG,CAAEtF,CAAF,CAAX;AACAyF,IAAAA,CAAC,CAACR,QAAF,CAAYpE,EAAZ,EAAgB2E,KAAK,CAAEC,CAAC,CAACV,EAAJ,CAArB,EAA+BtE,QAA/B;AAEA;AAED,CAXD,C,CAaA;AAEA;;;AAEA,IAAIiF,UAAU,GAAG,0BAAjB,C,CAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA,SAASC,UAAT,CAAqBC,SAArB,EAAgCC,aAAhC,EAAgD;AAE/CD,EAAAA,SAAS,CAACN,GAAV,CAAcQ,IAAd,CAAoBD,aAApB;AACAD,EAAAA,SAAS,CAACL,GAAV,CAAeM,aAAa,CAACd,EAA7B,IAAoCc,aAApC;AAEA;;AAED,SAASE,YAAT,CAAuBf,UAAvB,EAAmC/D,IAAnC,EAAyC2E,SAAzC,EAAqD;AAEpD,MAAII,IAAI,GAAGhB,UAAU,CAACiB,IAAtB;AAAA,MACCC,UAAU,GAAGF,IAAI,CAAC3F,MADnB,CAFoD,CAKpD;;AACAqF,EAAAA,UAAU,CAACS,SAAX,GAAuB,CAAvB;;AAEA,SAAQ,IAAR,EAAe;AAEd,QAAIC,KAAK,GAAGV,UAAU,CAACW,IAAX,CAAiBL,IAAjB,CAAZ;AAAA,QACCM,QAAQ,GAAGZ,UAAU,CAACS,SADvB;AAAA,QAGCpB,EAAE,GAAGqB,KAAK,CAAE,CAAF,CAHX;AAAA,QAICG,SAAS,GAAGH,KAAK,CAAE,CAAF,CAAL,KAAe,GAJ5B;AAAA,QAKCI,SAAS,GAAGJ,KAAK,CAAE,CAAF,CALlB;AAOA,QAAKG,SAAL,EAAiBxB,EAAE,GAAGA,EAAE,GAAG,CAAV,CATH,CASgB;;AAE9B,QAAKyB,SAAS,KAAK1G,SAAd,IAA2B0G,SAAS,KAAK,GAAd,IAAqBF,QAAQ,GAAG,CAAX,KAAiBJ,UAAtE,EAAmF;AAElF;AAEAP,MAAAA,UAAU,CAAEC,SAAF,EAAaY,SAAS,KAAK1G,SAAd,GACtB,IAAIgF,aAAJ,CAAmBC,EAAnB,EAAuBC,UAAvB,EAAmC/D,IAAnC,CADsB,GAEtB,IAAIiE,gBAAJ,CAAsBH,EAAtB,EAA0BC,UAA1B,EAAsC/D,IAAtC,CAFS,CAAV;AAIA;AAEA,KAVD,MAUO;AAEN;AAEA,UAAIsE,GAAG,GAAGK,SAAS,CAACL,GAApB;AAAA,UAAyBkB,IAAI,GAAGlB,GAAG,CAAER,EAAF,CAAnC;;AAEA,UAAK0B,IAAI,KAAK3G,SAAd,EAA0B;AAEzB2G,QAAAA,IAAI,GAAG,IAAIpB,iBAAJ,CAAuBN,EAAvB,CAAP;AACAY,QAAAA,UAAU,CAAEC,SAAF,EAAaa,IAAb,CAAV;AAEA;;AAEDb,MAAAA,SAAS,GAAGa,IAAZ;AAEA;AAED;AAED,C,CAED;;;AAEA,SAASC,aAAT,CAAwB7F,EAAxB,EAA4B8F,OAA5B,EAAsC;AAErC,OAAKrB,GAAL,GAAW,EAAX;AACA,OAAKC,GAAL,GAAW,EAAX;AAEA,MAAI3F,CAAC,GAAGiB,EAAE,CAAC+F,mBAAH,CAAwBD,OAAxB,EAAiC9F,EAAE,CAACgG,eAApC,CAAR;;AAEA,OAAM,IAAI7G,CAAC,GAAG,CAAd,EAAiBA,CAAC,GAAGJ,CAArB,EAAwB,EAAGI,CAA3B,EAA+B;AAE9B,QAAI8G,IAAI,GAAGjG,EAAE,CAACkG,gBAAH,CAAqBJ,OAArB,EAA8B3G,CAA9B,CAAX;AAAA,QACCiB,IAAI,GAAGJ,EAAE,CAACmG,kBAAH,CAAuBL,OAAvB,EAAgCG,IAAI,CAACb,IAArC,CADR;AAGAF,IAAAA,YAAY,CAAEe,IAAF,EAAQ7F,IAAR,EAAc,IAAd,CAAZ;AAEA;AAED;;AAEDyF,aAAa,CAACvB,SAAd,CAAwBF,QAAxB,GAAmC,UAAWpE,EAAX,EAAeoF,IAAf,EAAqBT,KAArB,EAA4B/E,QAA5B,EAAuC;AAEzE,MAAIgF,CAAC,GAAG,KAAKF,GAAL,CAAUU,IAAV,CAAR;AAEA,MAAKR,CAAC,KAAK3F,SAAX,EAAuB2F,CAAC,CAACR,QAAF,CAAYpE,EAAZ,EAAgB2E,KAAhB,EAAuB/E,QAAvB;AAEvB,CAND;;AAQAiG,aAAa,CAACvB,SAAd,CAAwB8B,WAAxB,GAAsC,UAAWpG,EAAX,EAAeqG,MAAf,EAAuBjB,IAAvB,EAA8B;AAEnE,MAAInF,CAAC,GAAGoG,MAAM,CAAEjB,IAAF,CAAd;AAEA,MAAKnF,CAAC,KAAKhB,SAAX,EAAuB,KAAKmF,QAAL,CAAepE,EAAf,EAAmBoF,IAAnB,EAAyBnF,CAAzB;AAEvB,CAND,C,CASA;;;AAEA4F,aAAa,CAACS,MAAd,GAAuB,UAAWtG,EAAX,EAAeyE,GAAf,EAAoB8B,MAApB,EAA4B3G,QAA5B,EAAuC;AAE7D,OAAM,IAAIT,CAAC,GAAG,CAAR,EAAWJ,CAAC,GAAG0F,GAAG,CAACjF,MAAzB,EAAiCL,CAAC,KAAKJ,CAAvC,EAA0C,EAAGI,CAA7C,EAAiD;AAEhD,QAAIyF,CAAC,GAAGH,GAAG,CAAEtF,CAAF,CAAX;AAAA,QACCc,CAAC,GAAGsG,MAAM,CAAE3B,CAAC,CAACV,EAAJ,CADX;;AAGA,QAAKjE,CAAC,CAACuG,WAAF,KAAkB,KAAvB,EAA+B;AAE9B;AACA5B,MAAAA,CAAC,CAACR,QAAF,CAAYpE,EAAZ,EAAgBC,CAAC,CAAC0E,KAAlB,EAAyB/E,QAAzB;AAEA;AAED;AAED,CAhBD;;AAkBAiG,aAAa,CAACY,YAAd,GAA6B,UAAWhC,GAAX,EAAgB8B,MAAhB,EAAyB;AAErD,MAAIvH,CAAC,GAAG,EAAR;;AAEA,OAAM,IAAIG,CAAC,GAAG,CAAR,EAAWJ,CAAC,GAAG0F,GAAG,CAACjF,MAAzB,EAAiCL,CAAC,KAAKJ,CAAvC,EAA0C,EAAGI,CAA7C,EAAiD;AAEhD,QAAIyF,CAAC,GAAGH,GAAG,CAAEtF,CAAF,CAAX;AACA,QAAKyF,CAAC,CAACV,EAAF,IAAQqC,MAAb,EAAsBvH,CAAC,CAACiG,IAAF,CAAQL,CAAR;AAEtB;;AAED,SAAO5F,CAAP;AAEA,CAbD;;AAeA,SAAS6G,aAAT","sourcesContent":["/**\n * @author tschw\n * @author Mugen87 / https://github.com/Mugen87\n * @author mrdoob / http://mrdoob.com/\n *\n * Uniforms of a program.\n * Those form a tree structure with a special top-level container for the root,\n * which you get by calling 'new WebGLUniforms( gl, program )'.\n *\n *\n * Properties of inner nodes including the top-level container:\n *\n * .seq - array of nested uniforms\n * .map - nested uniforms by name\n *\n *\n * Methods of all nodes except the top-level container:\n *\n * .setValue( gl, value, [textures] )\n *\n * \t\tuploads a uniform value(s)\n *  \tthe 'textures' parameter is needed for sampler uniforms\n *\n *\n * Static methods of the top-level container (textures factorizations):\n *\n * .upload( gl, seq, values, textures )\n *\n * \t\tsets uniforms in 'seq' to 'values[id].value'\n *\n * .seqWithValue( seq, values ) : filteredSeq\n *\n * \t\tfilters 'seq' entries with corresponding entry in values\n *\n *\n * Methods of the top-level container (textures factorizations):\n *\n * .setValue( gl, name, value, textures )\n *\n * \t\tsets uniform with  name 'name' to 'value'\n *\n * .setOptional( gl, obj, prop )\n *\n * \t\tlike .set for an optional property of the object\n *\n */\n\nimport { CubeTexture } from '../../textures/CubeTexture.js';\nimport { Texture } from '../../textures/Texture.js';\nimport { DataTexture2DArray } from '../../textures/DataTexture2DArray.js';\nimport { DataTexture3D } from '../../textures/DataTexture3D.js';\n\nvar emptyTexture = new Texture();\nvar emptyTexture2dArray = new DataTexture2DArray();\nvar emptyTexture3d = new DataTexture3D();\nvar emptyCubeTexture = new CubeTexture();\n\n// --- Utilities ---\n\n// Array Caches (provide typed arrays for temporary by size)\n\nvar arrayCacheF32 = [];\nvar arrayCacheI32 = [];\n\n// Float32Array caches used for uploading Matrix uniforms\n\nvar mat4array = new Float32Array( 16 );\nvar mat3array = new Float32Array( 9 );\nvar mat2array = new Float32Array( 4 );\n\n// Flattening for arrays of vectors and matrices\n\nfunction flatten( array, nBlocks, blockSize ) {\n\n\tvar firstElem = array[ 0 ];\n\n\tif ( firstElem <= 0 || firstElem > 0 ) return array;\n\t// unoptimized: ! isNaN( firstElem )\n\t// see http://jacksondunstan.com/articles/983\n\n\tvar n = nBlocks * blockSize,\n\t\tr = arrayCacheF32[ n ];\n\n\tif ( r === undefined ) {\n\n\t\tr = new Float32Array( n );\n\t\tarrayCacheF32[ n ] = r;\n\n\t}\n\n\tif ( nBlocks !== 0 ) {\n\n\t\tfirstElem.toArray( r, 0 );\n\n\t\tfor ( var i = 1, offset = 0; i !== nBlocks; ++ i ) {\n\n\t\t\toffset += blockSize;\n\t\t\tarray[ i ].toArray( r, offset );\n\n\t\t}\n\n\t}\n\n\treturn r;\n\n}\n\nfunction arraysEqual( a, b ) {\n\n\tif ( a.length !== b.length ) return false;\n\n\tfor ( var i = 0, l = a.length; i < l; i ++ ) {\n\n\t\tif ( a[ i ] !== b[ i ] ) return false;\n\n\t}\n\n\treturn true;\n\n}\n\nfunction copyArray( a, b ) {\n\n\tfor ( var i = 0, l = b.length; i < l; i ++ ) {\n\n\t\ta[ i ] = b[ i ];\n\n\t}\n\n}\n\n// Texture unit allocation\n\nfunction allocTexUnits( textures, n ) {\n\n\tvar r = arrayCacheI32[ n ];\n\n\tif ( r === undefined ) {\n\n\t\tr = new Int32Array( n );\n\t\tarrayCacheI32[ n ] = r;\n\n\t}\n\n\tfor ( var i = 0; i !== n; ++ i )\n\t\tr[ i ] = textures.allocateTextureUnit();\n\n\treturn r;\n\n}\n\n// --- Setters ---\n\n// Note: Defining these methods externally, because they come in a bunch\n// and this way their names minify.\n\n// Single scalar\n\nfunction setValueV1f( gl, v ) {\n\n\tvar cache = this.cache;\n\n\tif ( cache[ 0 ] === v ) return;\n\n\tgl.uniform1f( this.addr, v );\n\n\tcache[ 0 ] = v;\n\n}\n\n// Single float vector (from flat array or THREE.VectorN)\n\nfunction setValueV2f( gl, v ) {\n\n\tvar cache = this.cache;\n\n\tif ( v.x !== undefined ) {\n\n\t\tif ( cache[ 0 ] !== v.x || cache[ 1 ] !== v.y ) {\n\n\t\t\tgl.uniform2f( this.addr, v.x, v.y );\n\n\t\t\tcache[ 0 ] = v.x;\n\t\t\tcache[ 1 ] = v.y;\n\n\t\t}\n\n\t} else {\n\n\t\tif ( arraysEqual( cache, v ) ) return;\n\n\t\tgl.uniform2fv( this.addr, v );\n\n\t\tcopyArray( cache, v );\n\n\t}\n\n}\n\nfunction setValueV3f( gl, v ) {\n\n\tvar cache = this.cache;\n\n\tif ( v.x !== undefined ) {\n\n\t\tif ( cache[ 0 ] !== v.x || cache[ 1 ] !== v.y || cache[ 2 ] !== v.z ) {\n\n\t\t\tgl.uniform3f( this.addr, v.x, v.y, v.z );\n\n\t\t\tcache[ 0 ] = v.x;\n\t\t\tcache[ 1 ] = v.y;\n\t\t\tcache[ 2 ] = v.z;\n\n\t\t}\n\n\t} else if ( v.r !== undefined ) {\n\n\t\tif ( cache[ 0 ] !== v.r || cache[ 1 ] !== v.g || cache[ 2 ] !== v.b ) {\n\n\t\t\tgl.uniform3f( this.addr, v.r, v.g, v.b );\n\n\t\t\tcache[ 0 ] = v.r;\n\t\t\tcache[ 1 ] = v.g;\n\t\t\tcache[ 2 ] = v.b;\n\n\t\t}\n\n\t} else {\n\n\t\tif ( arraysEqual( cache, v ) ) return;\n\n\t\tgl.uniform3fv( this.addr, v );\n\n\t\tcopyArray( cache, v );\n\n\t}\n\n}\n\nfunction setValueV4f( gl, v ) {\n\n\tvar cache = this.cache;\n\n\tif ( v.x !== undefined ) {\n\n\t\tif ( cache[ 0 ] !== v.x || cache[ 1 ] !== v.y || cache[ 2 ] !== v.z || cache[ 3 ] !== v.w ) {\n\n\t\t\tgl.uniform4f( this.addr, v.x, v.y, v.z, v.w );\n\n\t\t\tcache[ 0 ] = v.x;\n\t\t\tcache[ 1 ] = v.y;\n\t\t\tcache[ 2 ] = v.z;\n\t\t\tcache[ 3 ] = v.w;\n\n\t\t}\n\n\t} else {\n\n\t\tif ( arraysEqual( cache, v ) ) return;\n\n\t\tgl.uniform4fv( this.addr, v );\n\n\t\tcopyArray( cache, v );\n\n\t}\n\n}\n\n// Single matrix (from flat array or MatrixN)\n\nfunction setValueM2( gl, v ) {\n\n\tvar cache = this.cache;\n\tvar elements = v.elements;\n\n\tif ( elements === undefined ) {\n\n\t\tif ( arraysEqual( cache, v ) ) return;\n\n\t\tgl.uniformMatrix2fv( this.addr, false, v );\n\n\t\tcopyArray( cache, v );\n\n\t} else {\n\n\t\tif ( arraysEqual( cache, elements ) ) return;\n\n\t\tmat2array.set( elements );\n\n\t\tgl.uniformMatrix2fv( this.addr, false, mat2array );\n\n\t\tcopyArray( cache, elements );\n\n\t}\n\n}\n\nfunction setValueM3( gl, v ) {\n\n\tvar cache = this.cache;\n\tvar elements = v.elements;\n\n\tif ( elements === undefined ) {\n\n\t\tif ( arraysEqual( cache, v ) ) return;\n\n\t\tgl.uniformMatrix3fv( this.addr, false, v );\n\n\t\tcopyArray( cache, v );\n\n\t} else {\n\n\t\tif ( arraysEqual( cache, elements ) ) return;\n\n\t\tmat3array.set( elements );\n\n\t\tgl.uniformMatrix3fv( this.addr, false, mat3array );\n\n\t\tcopyArray( cache, elements );\n\n\t}\n\n}\n\nfunction setValueM4( gl, v ) {\n\n\tvar cache = this.cache;\n\tvar elements = v.elements;\n\n\tif ( elements === undefined ) {\n\n\t\tif ( arraysEqual( cache, v ) ) return;\n\n\t\tgl.uniformMatrix4fv( this.addr, false, v );\n\n\t\tcopyArray( cache, v );\n\n\t} else {\n\n\t\tif ( arraysEqual( cache, elements ) ) return;\n\n\t\tmat4array.set( elements );\n\n\t\tgl.uniformMatrix4fv( this.addr, false, mat4array );\n\n\t\tcopyArray( cache, elements );\n\n\t}\n\n}\n\n// Single texture (2D / Cube)\n\nfunction setValueT1( gl, v, textures ) {\n\n\tvar cache = this.cache;\n\tvar unit = textures.allocateTextureUnit();\n\n\tif ( cache[ 0 ] !== unit ) {\n\n\t\tgl.uniform1i( this.addr, unit );\n\t\tcache[ 0 ] = unit;\n\n\t}\n\n\ttextures.safeSetTexture2D( v || emptyTexture, unit );\n\n}\n\nfunction setValueT2DArray1( gl, v, textures ) {\n\n\tvar cache = this.cache;\n\tvar unit = textures.allocateTextureUnit();\n\n\tif ( cache[ 0 ] !== unit ) {\n\n\t\tgl.uniform1i( this.addr, unit );\n\t\tcache[ 0 ] = unit;\n\n\t}\n\n\ttextures.setTexture2DArray( v || emptyTexture2dArray, unit );\n\n}\n\nfunction setValueT3D1( gl, v, textures ) {\n\n\tvar cache = this.cache;\n\tvar unit = textures.allocateTextureUnit();\n\n\tif ( cache[ 0 ] !== unit ) {\n\n\t\tgl.uniform1i( this.addr, unit );\n\t\tcache[ 0 ] = unit;\n\n\t}\n\n\ttextures.setTexture3D( v || emptyTexture3d, unit );\n\n}\n\nfunction setValueT6( gl, v, textures ) {\n\n\tvar cache = this.cache;\n\tvar unit = textures.allocateTextureUnit();\n\n\tif ( cache[ 0 ] !== unit ) {\n\n\t\tgl.uniform1i( this.addr, unit );\n\t\tcache[ 0 ] = unit;\n\n\t}\n\n\ttextures.safeSetTextureCube( v || emptyCubeTexture, unit );\n\n}\n\n// Integer / Boolean vectors or arrays thereof (always flat arrays)\n\nfunction setValueV1i( gl, v ) {\n\n\tvar cache = this.cache;\n\n\tif ( cache[ 0 ] === v ) return;\n\n\tgl.uniform1i( this.addr, v );\n\n\tcache[ 0 ] = v;\n\n}\n\nfunction setValueV2i( gl, v ) {\n\n\tvar cache = this.cache;\n\n\tif ( arraysEqual( cache, v ) ) return;\n\n\tgl.uniform2iv( this.addr, v );\n\n\tcopyArray( cache, v );\n\n}\n\nfunction setValueV3i( gl, v ) {\n\n\tvar cache = this.cache;\n\n\tif ( arraysEqual( cache, v ) ) return;\n\n\tgl.uniform3iv( this.addr, v );\n\n\tcopyArray( cache, v );\n\n}\n\nfunction setValueV4i( gl, v ) {\n\n\tvar cache = this.cache;\n\n\tif ( arraysEqual( cache, v ) ) return;\n\n\tgl.uniform4iv( this.addr, v );\n\n\tcopyArray( cache, v );\n\n}\n\n// Helper to pick the right setter for the singular case\n\nfunction getSingularSetter( type ) {\n\n\tswitch ( type ) {\n\n\t\tcase 0x1406: return setValueV1f; // FLOAT\n\t\tcase 0x8b50: return setValueV2f; // _VEC2\n\t\tcase 0x8b51: return setValueV3f; // _VEC3\n\t\tcase 0x8b52: return setValueV4f; // _VEC4\n\n\t\tcase 0x8b5a: return setValueM2; // _MAT2\n\t\tcase 0x8b5b: return setValueM3; // _MAT3\n\t\tcase 0x8b5c: return setValueM4; // _MAT4\n\n\t\tcase 0x8b5e: case 0x8d66: return setValueT1; // SAMPLER_2D, SAMPLER_EXTERNAL_OES\n\t\tcase 0x8b5f: return setValueT3D1; // SAMPLER_3D\n\t\tcase 0x8b60: return setValueT6; // SAMPLER_CUBE\n\t\tcase 0x8DC1: return setValueT2DArray1; // SAMPLER_2D_ARRAY\n\n\t\tcase 0x1404: case 0x8b56: return setValueV1i; // INT, BOOL\n\t\tcase 0x8b53: case 0x8b57: return setValueV2i; // _VEC2\n\t\tcase 0x8b54: case 0x8b58: return setValueV3i; // _VEC3\n\t\tcase 0x8b55: case 0x8b59: return setValueV4i; // _VEC4\n\n\t}\n\n}\n\n// Array of scalars\nfunction setValueV1fArray( gl, v ) {\n\n\tgl.uniform1fv( this.addr, v );\n\n}\n\n// Integer / Boolean vectors or arrays thereof (always flat arrays)\nfunction setValueV1iArray( gl, v ) {\n\n\tgl.uniform1iv( this.addr, v );\n\n}\n\nfunction setValueV2iArray( gl, v ) {\n\n\tgl.uniform2iv( this.addr, v );\n\n}\n\nfunction setValueV3iArray( gl, v ) {\n\n\tgl.uniform3iv( this.addr, v );\n\n}\n\nfunction setValueV4iArray( gl, v ) {\n\n\tgl.uniform4iv( this.addr, v );\n\n}\n\n\n// Array of vectors (flat or from THREE classes)\n\nfunction setValueV2fArray( gl, v ) {\n\n\tvar data = flatten( v, this.size, 2 );\n\n\tgl.uniform2fv( this.addr, data );\n\n}\n\nfunction setValueV3fArray( gl, v ) {\n\n\tvar data = flatten( v, this.size, 3 );\n\n\tgl.uniform3fv( this.addr, data );\n\n}\n\nfunction setValueV4fArray( gl, v ) {\n\n\tvar data = flatten( v, this.size, 4 );\n\n\tgl.uniform4fv( this.addr, data );\n\n}\n\n// Array of matrices (flat or from THREE clases)\n\nfunction setValueM2Array( gl, v ) {\n\n\tvar data = flatten( v, this.size, 4 );\n\n\tgl.uniformMatrix2fv( this.addr, false, data );\n\n}\n\nfunction setValueM3Array( gl, v ) {\n\n\tvar data = flatten( v, this.size, 9 );\n\n\tgl.uniformMatrix3fv( this.addr, false, data );\n\n}\n\nfunction setValueM4Array( gl, v ) {\n\n\tvar data = flatten( v, this.size, 16 );\n\n\tgl.uniformMatrix4fv( this.addr, false, data );\n\n}\n\n// Array of textures (2D / Cube)\n\nfunction setValueT1Array( gl, v, textures ) {\n\n\tvar n = v.length;\n\n\tvar units = allocTexUnits( textures, n );\n\n\tgl.uniform1iv( this.addr, units );\n\n\tfor ( var i = 0; i !== n; ++ i ) {\n\n\t\ttextures.safeSetTexture2D( v[ i ] || emptyTexture, units[ i ] );\n\n\t}\n\n}\n\nfunction setValueT6Array( gl, v, textures ) {\n\n\tvar n = v.length;\n\n\tvar units = allocTexUnits( textures, n );\n\n\tgl.uniform1iv( this.addr, units );\n\n\tfor ( var i = 0; i !== n; ++ i ) {\n\n\t\ttextures.safeSetTextureCube( v[ i ] || emptyCubeTexture, units[ i ] );\n\n\t}\n\n}\n\n// Helper to pick the right setter for a pure (bottom-level) array\n\nfunction getPureArraySetter( type ) {\n\n\tswitch ( type ) {\n\n\t\tcase 0x1406: return setValueV1fArray; // FLOAT\n\t\tcase 0x8b50: return setValueV2fArray; // _VEC2\n\t\tcase 0x8b51: return setValueV3fArray; // _VEC3\n\t\tcase 0x8b52: return setValueV4fArray; // _VEC4\n\n\t\tcase 0x8b5a: return setValueM2Array; // _MAT2\n\t\tcase 0x8b5b: return setValueM3Array; // _MAT3\n\t\tcase 0x8b5c: return setValueM4Array; // _MAT4\n\n\t\tcase 0x8b5e: // SAMPLER_2D\n\t\tcase 0x8d66: // SAMPLER_EXTERNAL_OES\n\t\tcase 0x8dca: // INT_SAMPLER_2D\n\t\tcase 0x8dd2: // UNSIGNED_INT_SAMPLER_2D\n\t\t\treturn setValueT1Array;\n\n\t\tcase 0x8b60: // SAMPLER_CUBE\n\t\tcase 0x8dcc: // INT_SAMPLER_CUBE\n\t\tcase 0x8dd4: // UNSIGNED_SAMPLER_CUBE\n\t\t\treturn setValueT6Array;\n\n\t\tcase 0x1404: case 0x8b56: return setValueV1iArray; // INT, BOOL\n\t\tcase 0x8b53: case 0x8b57: return setValueV2iArray; // _VEC2\n\t\tcase 0x8b54: case 0x8b58: return setValueV3iArray; // _VEC3\n\t\tcase 0x8b55: case 0x8b59: return setValueV4iArray; // _VEC4\n\n\t}\n\n}\n\n// --- Uniform Classes ---\n\nfunction SingleUniform( id, activeInfo, addr ) {\n\n\tthis.id = id;\n\tthis.addr = addr;\n\tthis.cache = [];\n\tthis.setValue = getSingularSetter( activeInfo.type );\n\n\t// this.path = activeInfo.name; // DEBUG\n\n}\n\nfunction PureArrayUniform( id, activeInfo, addr ) {\n\n\tthis.id = id;\n\tthis.addr = addr;\n\tthis.cache = [];\n\tthis.size = activeInfo.size;\n\tthis.setValue = getPureArraySetter( activeInfo.type );\n\n\t// this.path = activeInfo.name; // DEBUG\n\n}\n\nPureArrayUniform.prototype.updateCache = function ( data ) {\n\n\tvar cache = this.cache;\n\n\tif ( data instanceof Float32Array && cache.length !== data.length ) {\n\n\t\tthis.cache = new Float32Array( data.length );\n\n\t}\n\n\tcopyArray( cache, data );\n\n};\n\nfunction StructuredUniform( id ) {\n\n\tthis.id = id;\n\n\tthis.seq = [];\n\tthis.map = {};\n\n}\n\nStructuredUniform.prototype.setValue = function ( gl, value, textures ) {\n\n\tvar seq = this.seq;\n\n\tfor ( var i = 0, n = seq.length; i !== n; ++ i ) {\n\n\t\tvar u = seq[ i ];\n\t\tu.setValue( gl, value[ u.id ], textures );\n\n\t}\n\n};\n\n// --- Top-level ---\n\n// Parser - builds up the property tree from the path strings\n\nvar RePathPart = /([\\w\\d_]+)(\\])?(\\[|\\.)?/g;\n\n// extracts\n// \t- the identifier (member name or array index)\n//  - followed by an optional right bracket (found when array index)\n//  - followed by an optional left bracket or dot (type of subscript)\n//\n// Note: These portions can be read in a non-overlapping fashion and\n// allow straightforward parsing of the hierarchy that WebGL encodes\n// in the uniform names.\n\nfunction addUniform( container, uniformObject ) {\n\n\tcontainer.seq.push( uniformObject );\n\tcontainer.map[ uniformObject.id ] = uniformObject;\n\n}\n\nfunction parseUniform( activeInfo, addr, container ) {\n\n\tvar path = activeInfo.name,\n\t\tpathLength = path.length;\n\n\t// reset RegExp object, because of the early exit of a previous run\n\tRePathPart.lastIndex = 0;\n\n\twhile ( true ) {\n\n\t\tvar match = RePathPart.exec( path ),\n\t\t\tmatchEnd = RePathPart.lastIndex,\n\n\t\t\tid = match[ 1 ],\n\t\t\tidIsIndex = match[ 2 ] === ']',\n\t\t\tsubscript = match[ 3 ];\n\n\t\tif ( idIsIndex ) id = id | 0; // convert to integer\n\n\t\tif ( subscript === undefined || subscript === '[' && matchEnd + 2 === pathLength ) {\n\n\t\t\t// bare name or \"pure\" bottom-level array \"[0]\" suffix\n\n\t\t\taddUniform( container, subscript === undefined ?\n\t\t\t\tnew SingleUniform( id, activeInfo, addr ) :\n\t\t\t\tnew PureArrayUniform( id, activeInfo, addr ) );\n\n\t\t\tbreak;\n\n\t\t} else {\n\n\t\t\t// step into inner node / create it in case it doesn't exist\n\n\t\t\tvar map = container.map, next = map[ id ];\n\n\t\t\tif ( next === undefined ) {\n\n\t\t\t\tnext = new StructuredUniform( id );\n\t\t\t\taddUniform( container, next );\n\n\t\t\t}\n\n\t\t\tcontainer = next;\n\n\t\t}\n\n\t}\n\n}\n\n// Root Container\n\nfunction WebGLUniforms( gl, program ) {\n\n\tthis.seq = [];\n\tthis.map = {};\n\n\tvar n = gl.getProgramParameter( program, gl.ACTIVE_UNIFORMS );\n\n\tfor ( var i = 0; i < n; ++ i ) {\n\n\t\tvar info = gl.getActiveUniform( program, i ),\n\t\t\taddr = gl.getUniformLocation( program, info.name );\n\n\t\tparseUniform( info, addr, this );\n\n\t}\n\n}\n\nWebGLUniforms.prototype.setValue = function ( gl, name, value, textures ) {\n\n\tvar u = this.map[ name ];\n\n\tif ( u !== undefined ) u.setValue( gl, value, textures );\n\n};\n\nWebGLUniforms.prototype.setOptional = function ( gl, object, name ) {\n\n\tvar v = object[ name ];\n\n\tif ( v !== undefined ) this.setValue( gl, name, v );\n\n};\n\n\n// Static interface\n\nWebGLUniforms.upload = function ( gl, seq, values, textures ) {\n\n\tfor ( var i = 0, n = seq.length; i !== n; ++ i ) {\n\n\t\tvar u = seq[ i ],\n\t\t\tv = values[ u.id ];\n\n\t\tif ( v.needsUpdate !== false ) {\n\n\t\t\t// note: always updating when .needsUpdate is undefined\n\t\t\tu.setValue( gl, v.value, textures );\n\n\t\t}\n\n\t}\n\n};\n\nWebGLUniforms.seqWithValue = function ( seq, values ) {\n\n\tvar r = [];\n\n\tfor ( var i = 0, n = seq.length; i !== n; ++ i ) {\n\n\t\tvar u = seq[ i ];\n\t\tif ( u.id in values ) r.push( u );\n\n\t}\n\n\treturn r;\n\n};\n\nexport { WebGLUniforms };\n"]},"metadata":{},"sourceType":"module"}